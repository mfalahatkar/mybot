import os
from telegram import Update, ReplyKeyboardMarkup, ReplyKeyboardRemove
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    filters,
    ContextTypes,
    ConversationHandler,
)

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡
TOKEN = os.environ.get("TOKEN")
if not TOKEN:
    print("âŒ Ø®Ø·Ø§: ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª!")
    exit(1)

KM_PER_MISSION = 52  # Ú©ÛŒÙ„ÙˆÙ…ØªØ± Ù‡Ø± Ù…Ø§Ù…ÙˆØ±ÛŒØª Ø±Ø´Øª
PER_KM = 12596  # Ù‚ÛŒÙ…Øª Ù‡Ø± Ú©ÛŒÙ„ÙˆÙ…ØªØ±

# Ù…Ø§Ù‡â€ŒÙ‡Ø§
MONTHS = [
    "ÙØ±ÙˆØ±Ø¯ÛŒÙ†", "Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª", "Ø®Ø±Ø¯Ø§Ø¯", "ØªÛŒØ±", "Ù…Ø±Ø¯Ø§Ø¯", "Ø´Ù‡Ø±ÛŒÙˆØ±",
    "Ù…Ù‡Ø±", "Ø¢Ø¨Ø§Ù†", "Ø¢Ø°Ø±", "Ø¯ÛŒ", "Ø¨Ù‡Ù…Ù†", "Ø§Ø³ÙÙ†Ø¯",
]

# Ø­Ù‚ÙˆÙ‚ Ø³Ø§Ø¹ØªÛŒ Ø®ÙˆØ¯Ø±ÙˆÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ù„ 1404 (Ù†Ø±Ø® Ù†Ù‡Ø§ÛŒÛŒ)
CAR_SALARIES_1404 = {
    "Ø³Ø§ÛŒÙ†Ø§ Ùˆ ØªÛŒØ¨Ø§": {
        "Ù…Ø¯Ù„ Û±Û³Û¹Û¶-Û±Û³Û¹Û¸": 699712, 
        "Ù…Ø¯Ù„ Û¹Û¹ Ø¨Ù‡ Ø¨Ø§Ù„Ø§": 791564
    },
    "Ø³Ù…Ù†Ø¯ØŒ Ù¾Ú˜Ùˆ 405ØŒ Ù¾Ú˜Ùˆ Ù¾Ø§Ø±Ø³ØŒ Ø±Ø§Ù†Ø§ØŒ Ù¾Ú˜Ùˆ 206ØŒ MVM": {
        "Ù…Ø¯Ù„ Û±Û³Û¹Û²": 600510, 
        "Ù…Ø¯Ù„ Û±Û³Û¹Û³-Û±Û³Û¹Ûµ": 710735, 
        "Ù…Ø¯Ù„ Û±Û³Û¹Û¶-Û±Û³Û¹Û¸": 828307, 
        "Ù…Ø¯Ù„ Û¹Û¹ Ø¨Ù‡ Ø¨Ø§Ù„Ø§": 920159
    },
    "Ø¯Ù†Ø§ØŒ Ø´Ø§Ù‡ÛŒÙ†ØŒ Ø§Ù„ 90ØŒ Ø¨Ø±Ù„ÛŒØ§Ù†Ø³ØŒ Ù„ÛŒÙØ§Ù†": {
        "Ù…Ø¯Ù„ Û±Û³Û¹Û²": 662969, 
        "Ù…Ø¯Ù„ Û±Û³Û¹Û³-Û±Û³Û¹Ûµ": 772194, 
        "Ù…Ø¯Ù„ Û±Û³Û¹Û¶-Û±Û³Û¹Û¸": 901790, 
        "Ù…Ø¯Ù„ Û¹Û¹ Ø¨Ù‡ Ø¨Ø§Ù„Ø§": 993642
    },
}

# Ù…Ø±Ø§Ø­Ù„ Ú¯ÙØªÚ¯Ùˆ
(
    SELECT_MONTH,
    SELECT_CAR,
    SELECT_MODEL,
    GET_MISSIONS,
    GET_NORMAL_HOURS,
    GET_HOURLY_MISSIONS,
    SELECT_FINAL_ACTION,
) = range(7)


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    context.user_data["year"] = "1404"
    reply_keyboard = [MONTHS[i : i + 3][::-1] for i in range(0, len(MONTHS), 3)]
    await update.message.reply_text(
        "ðŸ“… Ù…Ø§Ù‡ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:",
        reply_markup=ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=True),
    )
    return SELECT_MONTH


async def select_month(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    month = update.message.text
    if month not in MONTHS:
        await update.message.reply_text(
            "âš ï¸ Ù…Ø§Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª!", reply_markup=ReplyKeyboardRemove()
        )
        return SELECT_MONTH

    context.user_data["month"] = month
    car_types = list(CAR_SALARIES_1404.keys())
    reply_keyboard = [[car] for car in car_types]
    await update.message.reply_text(
        "ðŸš— Ù†ÙˆØ¹ Ø®ÙˆØ¯Ø±Ùˆ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:",
        reply_markup=ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=True),
    )
    return SELECT_CAR


async def select_car(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    car_type = update.message.text
    if car_type not in CAR_SALARIES_1404:
        await update.message.reply_text(
            "âš ï¸ Ù†ÙˆØ¹ Ø®ÙˆØ¯Ø±Ùˆ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª!", reply_markup=ReplyKeyboardRemove()
        )
        return SELECT_CAR

    context.user_data["car_type"] = car_type
    models = list(CAR_SALARIES_1404[car_type].keys())
    reply_keyboard = [[model] for model in models]
    await update.message.reply_text(
        "ðŸ”§ Ù…Ø¯Ù„ Ø®ÙˆØ¯Ø±Ùˆ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:",
        reply_markup=ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=True),
    )
    return SELECT_MODEL


async def select_model(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    car_type = context.user_data["car_type"]
    model = update.message.text
    if model not in CAR_SALARIES_1404[car_type]:
        await update.message.reply_text(
            "âš ï¸ Ù…Ø¯Ù„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª!", reply_markup=ReplyKeyboardRemove()
        )
        return SELECT_MODEL

    context.user_data["model"] = model
    context.user_data["hourly_wage"] = CAR_SALARIES_1404[car_type][model]

    await update.message.reply_text(
        f"âœ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®ÙˆØ¯Ø±Ùˆ:\n"
        f"â€¢ {car_type} - {model}\n\n"
        "ðŸ”¢ ØªØ¹Ø¯Ø§Ø¯ Ù…Ø§Ù…ÙˆØ±ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø±Ø´Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:",
        reply_markup=ReplyKeyboardRemove(),
    )
    return GET_MISSIONS


async def get_missions(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    try:
        missions = int(update.message.text)
        if missions < 0:
            await update.message.reply_text("âŒ Ø¹Ø¯Ø¯ Ù…Ù†ÙÛŒ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ø§Ø´Ø¯!")
            return GET_MISSIONS

        context.user_data["missions"] = missions
        await update.message.reply_text("â° Ø³Ø§Ø¹Øª Ú©Ø§Ø± Ø¹Ø§Ø¯ÛŒ:")
        return GET_NORMAL_HOURS

    except ValueError:
        await update.message.reply_text("âŒ Ø¹Ø¯Ø¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯!")
        return GET_MISSIONS


async def get_normal_hours(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    try:
        normal_hours = float(update.message.text)
        if normal_hours < 0:
            await update.message.reply_text("âŒ Ø¹Ø¯Ø¯ Ù…Ù†ÙÛŒ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ø§Ø´Ø¯!")
            return GET_NORMAL_HOURS

        context.user_data["normal_hours"] = normal_hours
        await update.message.reply_text("â±ï¸ Ù…Ø§Ù…ÙˆØ±ÛŒØª Ø³Ø§Ø¹ØªÛŒ:")
        return GET_HOURLY_MISSIONS

    except ValueError:
        await update.message.reply_text("âŒ Ø¹Ø¯Ø¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯!")
        return GET_NORMAL_HOURS


async def get_hourly_missions(
    update: Update, context: ContextTypes.DEFAULT_TYPE
) -> int:
    try:
        hourly_missions = float(update.message.text)
        if hourly_missions < 0:
            await update.message.reply_text("âŒ Ø¹Ø¯Ø¯ Ù…Ù†ÙÛŒ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ø§Ø´Ø¯!")
            return GET_HOURLY_MISSIONS

        data = context.user_data

        # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø§Ù…ÙˆØ±ÛŒØª Ø±Ø´Øª
        mission_km_total = data["missions"] * KM_PER_MISSION
        mission_cost = mission_km_total * PER_KM

        # Ø­Ù‚ÙˆÙ‚ Ø³Ø§ÛŒØ± Ù‚Ø³Ù…Øªâ€ŒÙ‡Ø§
        normal_salary = data["normal_hours"] * data["hourly_wage"]
        hourly_mission_cost = hourly_missions * data["hourly_wage"]

        # Ù…Ø¬Ù…ÙˆØ¹
        total = mission_cost + normal_salary + hourly_mission_cost

        # ÙØ±Ù…Øªâ€ŒØ¨Ù†Ø¯ÛŒ Ø§Ø¹Ø¯Ø§Ø¯
        def format_currency(amount):
            return "{:,.0f}".format(amount).replace(",", "Ù¬")

        result = (
            f"ðŸ“„ **Ø­Ù‚ÙˆÙ‚ {data['month']} {data['year']}**\n\n"
            f"ðŸš— {data['car_type']} | {data['model']}\n\n"
            f"ðŸ›£ï¸ Ù…Ø§Ù…ÙˆØ±ÛŒØª Ø±Ø´Øª: {data['missions']} Ã— {KM_PER_MISSION} Ú©ÛŒÙ„ÙˆÙ…ØªØ± = {format_currency(mission_km_total)} Ú©ÛŒÙ„ÙˆÙ…ØªØ±\n"
            f"â€¢ Ù‡Ø²ÛŒÙ†Ù‡: {format_currency(mission_cost)} Ø±ÛŒØ§Ù„\n\n"
            f"â±ï¸ Ø³Ø§Ø¹Øª Ú©Ø§Ø± Ø¹Ø§Ø¯ÛŒ: {data['normal_hours']:.1f} Ã— {format_currency(data['hourly_wage'])} = {format_currency(normal_salary)} Ø±ÛŒØ§Ù„\n\n"
            f"ðŸ“ Ù…Ø§Ù…ÙˆØ±ÛŒØª Ø³Ø§Ø¹ØªÛŒ: {hourly_missions:.1f} Ã— {format_currency(data['hourly_wage'])} = {format_currency(hourly_mission_cost)} Ø±ÛŒØ§Ù„\n\n"
            f"ðŸ’° **Ø¬Ù…Ø¹ Ú©Ù„:** {format_currency(total)} Ø±ÛŒØ§Ù„\n\n"
            f"Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¬Ø¯Ø¯ Ø±ÙˆÛŒ /start Ø¨Ø²Ù†ÛŒØ¯."
        )

        await update.message.reply_text(result, reply_markup=ReplyKeyboardRemove())

        # Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²ÛŒÙ†Ù‡ Ø´Ø±ÙˆØ¹ Ø¯ÙˆØ¨Ø§Ø±Ù‡
        reply_keyboard = [["ðŸ”„ Ø´Ø±ÙˆØ¹ Ø¯ÙˆØ¨Ø§Ø±Ù‡"]]
        await update.message.reply_text(
            "Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:",
            reply_markup=ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=True),
        )
        return SELECT_FINAL_ACTION

    except ValueError:
        await update.message.reply_text("âŒ Ù„Ø·ÙØ§Ù‹ Ø¹Ø¯Ø¯ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.")
        return GET_HOURLY_MISSIONS


async def handle_final_action(
    update: Update, context: ContextTypes.DEFAULT_TYPE
) -> int:
    action = update.message.text
    if action == "ðŸ”„ Ø´Ø±ÙˆØ¹ Ø¯ÙˆØ¨Ø§Ø±Ù‡":
        return await start(update, context)
    return ConversationHandler.END


async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    await update.message.reply_text(
        "â›” Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯.", reply_markup=ReplyKeyboardRemove()
    )
    return ConversationHandler.END


def main():
    application = Application.builder().token(TOKEN).build()

    conv_handler = ConversationHandler(
        entry_points=[CommandHandler("start", start)],
        states={
            SELECT_MONTH: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, select_month)
            ],
            SELECT_CAR: [MessageHandler(filters.TEXT & ~filters.COMMAND, select_car)],
            SELECT_MODEL: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, select_model)
            ],
            GET_MISSIONS: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, get_missions)
            ],
            GET_NORMAL_HOURS: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, get_normal_hours)
            ],
            GET_HOURLY_MISSIONS: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, get_hourly_missions)
            ],
            SELECT_FINAL_ACTION: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, handle_final_action)
            ],
        },
        fallbacks=[CommandHandler("cancel", cancel)],
    )

    application.add_handler(conv_handler)
    print("âœ… Ø±Ø¨Ø§Øª Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª!")
    application.run_polling(drop_pending_updates=True)


if __name__ == "__main__":
    main()
